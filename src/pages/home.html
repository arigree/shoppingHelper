<section>
  <div style="margin-bottom: 18px">
    <!-- search box -->
    <div
      style="
        max-width: 820px;
        margin: 0 auto 18px;
        display: flex;
        gap: 12px;
        align-items: center;
      "
    >
      <input
        id="homeSearchInput"
        type="search"
        placeholder="Search products (e.g. apple)"
        style="
          flex: 1;
          padding: 12px 14px;
          border-radius: 12px;
          border: none;
          background: #fff;
        "
      />
      <button id="homeSearchBtn" class="btn btn-secondary">Search</button>
    </div>

    <!-- category things -->
    <div
      id="categoriesRow"
      style="
        display: flex;
        gap: 8px;
        justify-content: center;
        flex-wrap: wrap;
        margin-bottom: 12px;
      "
    ></div>

    <!-- product grid -->
    <div
      id="productsGrid"
      style="
        display: grid;
        gap: 18px;
        grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
        max-width: 980px;
        margin: 18px auto;
      "
    >
      <!-- product cards here -->
    </div>

    <div style="max-width: 980px; margin: 12px auto; text-align: center">
      <button id="refreshBtn" class="btn btn-ghost">Refresh</button>
      <div id="homeStatus" style="margin-top: 10px; color: #777"></div>
    </div>
  </div>

  <script type="module">
    import {
      getRandomProductsForCategory,
      getProductsByCategory,
    } from "/src/openFoodFactsApi.js";

    const categories = [
      "Fruits",
      "Vegetables",
      "Bakery",
      "Snacks",
      "Beverages",
      "Dairy",
    ];

    const categoriesRow = document.getElementById("categoriesRow");
    const productsGrid = document.getElementById("productsGrid");
    const homeStatus = document.getElementById("homeStatus");
    const searchInput = document.getElementById("homeSearchInput");
    const searchBtn = document.getElementById("homeSearchBtn");
    const refreshBtn = document.getElementById("refreshBtn");

    let activeCategory = "Fruits";

    function makeChip(name) {
      const btn = document.createElement("button");
      btn.className = "pill";
      btn.textContent = name;
      btn.style.borderRadius = "999px";
      btn.style.padding = "8px 12px";
      btn.style.background = name === activeCategory ? "var(--signup)" : "#fff";
      btn.style.color = name === activeCategory ? "#fff" : "#333";
      btn.style.boxShadow = "0 4px 8px rgba(0,0,0,0.04)";
      btn.addEventListener("click", async () => {
        if (activeCategory === name) return;
        setActiveCategory(name);
        await loadCategory(name);
      });
      return btn;
    }

    function setActiveCategory(name) {
      activeCategory = name;
      // update cat things highlight
      Array.from(categoriesRow.children).forEach((node) => {
        node.style.background =
          node.textContent === name ? "var(--signup)" : "#fff";
        node.style.color = node.textContent === name ? "#fff" : "#333";
      });
    }

    function clearProducts() {
      productsGrid.innerHTML = "";
    }

    function renderProductCard(p) {
      const title = p.product_name || p.generic_name || "No name";
      const img =
        p.image_front_small_url ||
        p.image_front_url ||
        p.image_url ||
        "/public/images/logo.png";
      const ecoscore = (p.ecoscore_grade || "").toUpperCase();
      // small green dot if ecoscore A/B else yellow/orange/red if lower
      let dotColor = "#d9d9d9";
      if (ecoscore === "A" || ecoscore === "B") dotColor = "#27C427";
      else if (ecoscore === "C") dotColor = "#FFC300";
      else if (ecoscore === "D" || ecoscore === "E") dotColor = "#FF6B6B";

      const card = document.createElement("div");
      card.style.background = "#fff";
      card.style.borderRadius = "12px";
      card.style.padding = "12px";
      card.style.textAlign = "center";
      card.style.boxShadow = "0 6px 18px rgba(0,0,0,0.04)";
      card.style.minHeight = "200px";
      card.style.position = "relative";
      card.innerHTML = `
        <div style="height:120px; display:flex; align-items:center; justify-content:center; overflow:hidden;">
          <img src="${img}" alt="${title}" style="max-height:110px; max-width:100%; object-fit:contain;">
        </div>
        <div style="font-weight:700; margin-top:8px; font-size:14px;">${escapeHtml(
          title
        )}</div>
        
      `;

      // ecoscore dot
      const dot = document.createElement("div");
      dot.style.width = "12px";
      dot.style.height = "12px";
      dot.style.borderRadius = "50%";
      dot.style.background = dotColor;
      dot.style.position = "absolute";
      dot.style.top = "12px";
      dot.style.right = "12px";
      card.appendChild(dot);

      card.addEventListener("click", () => {
        if (p.code) {
          window.location.href = `/src/pages/product.html?code=${encodeURI(
            p.code
          )}`;
        }
      });

      productsGrid.appendChild(card);
    }

    function escapeHtml(str) {
      return String(str).replace(
        /[&<>"']/g,
        (m) =>
          ({
            "&": "&amp;",
            "<": "&lt;",
            ">": "&gt;",
            '"': "&quot;",
            "'": "&#39;",
          }[m])
      );
    }

    async function loadCategory(catName) {
      clearProducts();
      homeStatus.textContent = `Loading ${catName}...`;
      try {
        // get a handful of random products
        const prods = await getRandomProductsForCategory(catName, 6, 50, {
          country: "United States",
        });
        if (!prods || prods.length === 0) {
          homeStatus.textContent = "No products found for that category.";
          return;
        }
        homeStatus.textContent = "";
        prods.forEach(renderProductCard);
      } catch (err) {
        console.error(err);
        homeStatus.textContent = "Error loading products.";
      }
    }

    async function performSearch(term) {
      clearProducts();
      homeStatus.textContent = `Searching for "${term}"...`;
      try {
        // Use category search to get matches across OpenFoodFacts
        const results = await getProductsByCategory(term, 24, {
          country: "United States",
        }).catch(async () => {
          // fallback: treat term as free text search by calling the API directly
          const url = new URL("https://world.openfoodfacts.org/cgi/search.pl");
          url.searchParams.set("search_terms", term);
          url.searchParams.set("search_simple", "1");
          url.searchParams.set("action", "process");
          url.searchParams.set("json", "1");
          url.searchParams.set("page_size", "24");
          const res = await fetch(url.toString());
          const json = await res.json();
          return json.products || [];
        });

        const filtered = (results || []).filter(
          (p) =>
            p.product_name &&
            (p.image_front_small_url || p.image_front_url || p.image_url)
        );
        if (!filtered.length) {
          homeStatus.textContent = "No results";
          return;
        }
        homeStatus.textContent = "";
        filtered.slice(0, 12).forEach(renderProductCard);
      } catch (err) {
        console.error(err);
        homeStatus.textContent = "Search error";
      }
    }

    categories.forEach((c) => categoriesRow.appendChild(makeChip(c)));
    setActiveCategory(activeCategory);

    // initial load
    loadCategory(activeCategory);

    // hooks
    searchBtn.addEventListener("click", () => {
      const t = searchInput.value.trim();
      if (!t) return;
      performSearch(t);
    });
    searchInput.addEventListener("keydown", (e) => {
      if (e.key === "Enter") searchBtn.click();
    });
    refreshBtn.addEventListener("click", () => loadCategory(activeCategory));
  </script>
</section>
